<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title> Projets Hypermedia </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap (styles rapides) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="style.css" rel="stylesheet">
  <!-- D3 pour lire le CSV simplement -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
 
  
</head>
<body>
  <div class="container py-4">

    <header class="mb-3">
      <h1 class="h3 mb-1">Projets Hypermédias</h1>
      <div class="text-muted">Source : Google Sheets (mise à jour automatique quand le formulaire reçoit des réponses)</div>
    </header>

    <!-- Lien vers le formulaire -->
    <div class="mb-3 d-flex gap-2 justify-content-end">
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSdiN480uyDaPTyZ0nF_PSbIRnjgqVKhmPHMDZewu864lXT0xg/viewform?usp=header"
         target="_blank" rel="noopener"
         class="btn btn-primary btn-lg">➕ Remplir le formulaire</a>
    </div>

    <!-- Barre outils -->
    <div class="searchbar">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6">
          <input id="q" class="form-control form-control-lg" placeholder="Rechercher (plein texte)"/>
        </div>
        <div class="col-6 col-md-3">
          <select id="keySelect" class="form-select">
            <option value="">— Filtrer par colonne —</option>
          </select>
        </div>
        <div class="col-6 col-md-3 text-md-end">
          <a id="downloadCsv" class="btn btn-outline-primary" target="_blank" rel="noopener">Télécharger le CSV</a>
        </div>
      </div>
    </div>

    <!-- Résumé -->
    <div class="mt-2 mb-2"><span id="count">Chargement…</span></div>

    <!-- Tableau -->
    <div class="table-responsive">
      <table id="dataTable" class="table table-sm table-striped table-hover align-middle mb-0">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>
  (function(){
    // === CONFIG ===
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vREH0YrVGx0VyRdsIamPOa4NWriyGPgDFFbpRcR5vwRdVtaU8SV4TxhU6yHDYswrlwHh3BKp8BkxHyY/pub?gid=898824701&single=true&output=csv";

    // === STATE ===
    let RAW = [], FILTERED = [], COLS = [];

    // === UTILS ===
    const norm = s => (s||"").toString().trim();
    const lc = s => norm(s).toLowerCase();
    const deburr = s => lc(s).normalize('NFD').replace(/\p{Diacritic}/gu,'');
    function isUrl(s){ return /^https?:\/\/|^www\./i.test(s||""); }
    function escapeHtml(s){ return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
    function linkify(s){ return isUrl(s) ? `<a href="${s}" target="_blank" rel="noopener">${escapeHtml(s)}</a>` : escapeHtml(s); }

    // === RENDER TABLE ===
    function renderTable(rows){
      const thead = d3.select("#dataTable thead");
      const tbody = d3.select("#dataTable tbody");
      thead.html(""); tbody.html("");

      // Header
      const trh = thead.append("tr");
      COLS.forEach(c => trh.append("th").text(c));

      // Body
      const trs = tbody.selectAll("tr").data(rows).enter().append("tr");
      trs.each(function(row){
        const tr = d3.select(this);
        COLS.forEach(c => {
          const val = norm(row[c]);
          tr.append("td").html(linkify(val));
        });
      });

      // Count
      d3.select("#count").text(`${rows.length} ligne(s)`);
    }

    // === FILTERS ===
    function populateKeySelect(){
      const sel = document.getElementById("keySelect");
      sel.innerHTML = `<option value="">— Filtrer par colonne —</option>`;
      COLS.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k; opt.textContent = k; sel.appendChild(opt);
      });
    }

    function applyFilters(){
      const q = document.getElementById("q").value || "";
      const key = document.getElementById("keySelect").value || "";
      const qn = deburr(q);

      FILTERED = RAW.filter(row => {
        if(key){ return deburr(row[key] || "").includes(qn); }
        return COLS.some(c => deburr(row[c] || "").includes(qn));
      });
      renderTable(FILTERED);
    }

    // === INIT ===
    document.getElementById("downloadCsv").href = CSV_URL;

    d3.csv(CSV_URL).then(rows => {
      // Nettoyage
      RAW = rows.map(r => {
        const o = {};
        Object.keys(r).forEach(k => { o[k.trim()] = (r[k] ?? "").toString().trim(); });
        return o;
      });

      // Colonnes (dans l'ordre du CSV)
      COLS = RAW.length ? Object.keys(RAW[0]) : [];
      populateKeySelect();

      FILTERED = RAW.slice();
      renderTable(FILTERED);

      // Listeners
      document.getElementById("q").addEventListener("input", applyFilters);
      document.getElementById("keySelect").addEventListener("change", applyFilters);
    }).catch(err => {
      console.error(err);
      d3.select("#count").text("Erreur de chargement du CSV. Vérifie la publication de la feuille.");
    });
  })();
  </script>
</body>
</html>