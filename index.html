<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>THYP 25-26 — Projets (depuis Google Sheets)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap (styles rapides) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- D3 pour lire le CSV simplement -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* ============================
   THYP — Thème coloré premium
   ============================ */
/* Palette */
:root{
  --bg: #0f1324;               /* fond global */
  --bg-soft: #111633;          /* zones collantes / barres */
  --card: #151a3a;             /* cartes */
  --text: #e8eaf6;
  --muted: #a9b0d1;
  --border: #2a315e;

  --acc1: #7c3aed;             /* violet */
  --acc2: #06b6d4;             /* cyan */
  --acc3: #22d3ee;             /* cyan clair */
  --acc4: #a78bfa;             /* violet clair */

  --grad-1: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
  --grad-2: linear-gradient(135deg, #22d3ee 0%, #a78bfa 100%);
  --shadow-sm: 0 10px 25px rgba(0,0,0,.22);
  --shadow-md: 0 20px 45px rgba(0,0,0,.35);
  --radius-lg: 18px;
  --radius-pill: 999px;
}

/* Base */
html,body{ background: radial-gradient(1200px 800px at 20% -10%, #1b2150 0%, #0f1324 55%) fixed; }
body{
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
h1,h2,h3,h4,h5{ letter-spacing:.2px; }

/* Header */
header h1{
  font-weight: 800;
  background: var(--grad-1);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
header .text-muted{
  color: var(--muted)!important;
}

/* Barre outils (sticky + verre dépoli + halo gradient) */
.searchbar{
  position: sticky; top: 0; z-index: 30;
  padding: 1rem 0 .85rem;
  background: linear-gradient(180deg, rgba(17,22,51,.9) 0%, rgba(17,22,51,.6) 100%);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255,255,255,.06);
  box-shadow: 0 20px 40px rgba(7, 10, 32, .35);
}
.searchbar input.form-control{
  border-radius: var(--radius-lg);
  background: #0e1330;
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03), var(--shadow-sm);
}
.searchbar input.form-control::placeholder{ color:#8791c2; }
.searchbar input.form-control:focus{
  border-color: transparent;
  box-shadow: 0 0 0 3px rgba(124,58,237,.35), 0 0 0 6px rgba(6,182,212,.2);
  outline: none;
}
.searchbar .form-select{
  border-radius: var(--radius-pill);
  background: #0e1330;
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
}
a#downloadCsv.btn{
  border-radius: var(--radius-pill);
  border: 1px solid transparent;
  background-image: var(--grad-2);
  color: #0b0f24;
  font-weight: 700;
  box-shadow: 0 6px 20px rgba(34,211,238,.25);
}
a#downloadCsv.btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }

/* Compteur */
#count{ color: var(--muted); }

/* Grille */
.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill,minmax(360px,1fr));
  gap: 1.25rem;
}

/* Cartes avec bordure dégradée subtile */
.card{
  position: relative;
  border: 0;
  border-radius: var(--radius-lg);
  background: var(--card);
  box-shadow: var(--shadow-sm);
  transition: transform .18s ease, box-shadow .18s ease;
  overflow: hidden;
}
.card::before{
  content:"";
  position:absolute; inset:-1px;
  border-radius: calc(var(--radius-lg) + 1px);
  padding: 1px;
  background: linear-gradient(135deg, rgba(124,58,237,.55), rgba(6,182,212,.55));
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
}
.card:hover{
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}
.card .card-body{ padding: 1.15rem 1.15rem 1rem; }

.card-title{
  color: #f3f4ff;
  font-weight: 800;
  line-height: 1.2;
  margin-bottom: .5rem!important;
  display: -webkit-box;
  -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden;
}
.card-text{ color:#dbe2ff; opacity:.95; }

/* Sous-sections */
.card .muted.fw-semibold{
  color: #b4baf0!important;
  font-weight: 700!important;
  text-transform: none;
  letter-spacing:.25px;
  margin-top: .25rem;
  margin-bottom: .35rem!important;
}

/* Pills dynamiques (couleurs alternées) */
.pill{
  display:inline-block;
  border-radius: var(--radius-pill);
  padding:.28rem .65rem;
  font-size:.84rem;
  line-height:1;
  margin:.2rem .28rem 0 0;
  color:#0b0f24;
  background: var(--grad-2);
  box-shadow: 0 6px 18px rgba(167,139,250,.25);
}
.pill:nth-child(2n){ background: var(--grad-1); box-shadow: 0 6px 18px rgba(6,182,212,.25); }
.pill:nth-child(3n){ background: linear-gradient(135deg, #ff6b6b, #f7d794); box-shadow: 0 6px 18px rgba(255,107,107,.25); }

/* Badges (key:value) */
.badge-kv{
  display:inline-flex; align-items:center; gap:.35rem;
  border-radius: 12px;
  padding:.42rem .6rem;
  font-size:.85rem;
  background: #0e1330;
  color: var(--text);
  border: 1px solid var(--border);
  margin:.28rem .35rem .28rem 0;
}
.badge-kv .key{ color:#c7cffb; font-weight:700; }

/* Liens dans badges / blocs */
.badge-kv a{ color:#9bd8ff; text-decoration: underline dotted; }
.badge-kv a:hover{ color:#b7e6ff; text-decoration: underline; }

/* Boutons génériques */
a.btn{ transition: transform .12s ease, filter .12s ease; }
a.btn:active{ transform: translateY(1px) scale(.99); }

/* Scrollbar (webkit) */
*::-webkit-scrollbar{ width: 10px; height: 10px; }
*::-webkit-scrollbar-thumb{ background: #2b356a; border-radius: 10px; }
*::-webkit-scrollbar-track{ background: transparent; }

/* Petites largeurs */
@media (max-width: 480px){
  .grid{ grid-template-columns: 1fr; }
  .searchbar .row > *{ margin-bottom:.5rem; }
}


  </style>
  
</head>
<body>
  <div class="container py-4">
    <header class="mb-3">
      <h1 class="h3 mb-1">THYP 25-26 — Projets</h1>
      <div class="text-muted">Source : Google Sheets (mise à jour automatique quand le formulaire reçoit des réponses)</div>
    </header>

    <!-- Barre outils -->
    <div class="searchbar">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6">
          <input id="q" class="form-control form-control-lg" placeholder="Rechercher (titre, résumé, objectifs, techno…)" />
        </div>
        <div class="col-6 col-md-3">
          <select id="keySelect" class="form-select">
            <option value="">— Filtrer par colonne —</option>
          </select>
        </div>
        <div class="col-6 col-md-3 text-md-end">
          <a id="downloadCsv" class="btn btn-outline-primary" target="_blank" rel="noopener">Télécharger le CSV</a>
        </div>
      </div>
    </div>

    <!-- Résumé -->
    <div class="mt-3 mb-2">
      <span id="count" class="muted">Chargement…</span>
    </div>

    <!-- Grille cartes -->
    <div id="grid" class="grid"></div>

    <p class="footer-note mt-4 muted">
      Astuce : ce gabarit s’adapte automatiquement aux intitulés de questions de ton formulaire (il n’exige pas des noms de colonnes précis).
    </p>
  </div>

  <script>
  (function(){
    // === 1) CONFIG ===
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vREH0YrVGx0VyRdsIamPOa4NWriyGPgDFFbpRcR5vwRdVtaU8SV4TxhU6yHDYswrlwHh3BKp8BkxHyY/pub?output=csv";

    // Indices/alias probables pour mieux titrer les cartes (si présents)
    const TITLE_HINTS = [
      "Titre du projet","Titre","Project title","Nom du projet"
    ];
    const SUMMARY_HINTS = [
      "Résumé","Résumé du projet","Description","Pitch","Synthèse"
    ];

    // Groupes (affichage structuré si on reconnaît ces colonnes)
    const GROUPS = {
      "Contenu & objectifs": [
        "Objectifs","Objectifs principaux du projet","Problématique","Problématique / besoin",
        "Public cible","Audience","Cible"
      ],
      "Aspects techniques": [
        "Technologies envisagées","Technologies","Type de médias intégrés","Médias",
        "Fonctionnalités prévues","Fonctionnalités"
      ],
      "Références": [
        "Liens utiles","Liens","URL","Références","Ressources prévues","Ressources"
      ]
    };

    // === 2) ÉTAT ===
    let RAW = [];
    let FILTERED = [];
    let ALL_KEYS = [];

    // === 3) OUTILS ===
    const norm = s => (s||"").toString().trim();
    const lc = s => norm(s).toLowerCase();

    function pickFirstKey(obj, hints){
      for(const h of hints){
        const k = Object.keys(obj).find(k => lc(k) === lc(h));
        if(k) return k;
      }
      // fallback: rien trouvé
      return null;
    }

    function splitMulti(val){
      // Gère cases à cocher (souvent CSV = "A, B, C")
      if(!val) return [];
      // Sépare par ; ou , (selon paramétrage de Google Sheets)
      return val.split(/[,;]\s*/).map(v => v.trim()).filter(Boolean);
    }

    function buildCard(row){
      // 1) Titre + résumé (si colonnes devinées)
      const titleKey = pickFirstKey(row, TITLE_HINTS);
      const sumKey   = pickFirstKey(row, SUMMARY_HINTS);
      const title = norm(row[titleKey]) || "Projet sans titre";
      const summary = norm(row[sumKey]) || "";

      // 2) Préparer sections par groupe
      const sections = [];

      for(const [label, columns] of Object.entries(GROUPS)){
        const present = columns
          .map(colName => {
            const k = Object.keys(row).find(k => lc(k) === lc(colName));
            return k || null;
          })
          .filter(Boolean);

        if(present.length){
          const items = present.map(k => {
            const v = norm(row[k]);
            if(!v) return null;

            // Affichage intelligent : si liste, présenter en "pills"
            const parts = splitMulti(v);
            if(parts.length > 1){
              const pills = parts.map(x => `<span class="pill">${escapeHtml(x)}</span>`).join(" ");
              return `<div class="mb-2"><div class="key">${escapeHtml(k)}</div><div>${pills}</div></div>`;
            }
            // URL auto-liées
            if(isLikelyUrl(v)){
              return `<div class="mb-2"><div class="key">${escapeHtml(k)}</div><div><a href="${escapeUrl(v)}" target="_blank" rel="noopener">${escapeHtml(v)}</a></div></div>`;
            }
            // Paragraphe simple
            return `<div class="mb-2"><div class="key">${escapeHtml(k)}</div><div>${escapeHtml(v)}</div></div>`;
          }).filter(Boolean);

          if(items.length){
            sections.push(`
              <div class="mb-2">
                <div class="muted fw-semibold mb-1">${label}</div>
                ${items.join("")}
              </div>
            `);
          }
        }
      }

      // 3) Colonnes non classées (pour ne rien perdre)
      const groupedKeys = new Set(
        [].concat(...Object.values(GROUPS)).map(x => lc(x))
      );
      if(titleKey) groupedKeys.add(lc(titleKey));
      if(sumKey) groupedKeys.add(lc(sumKey));

      const misc = Object.keys(row)
        .filter(k => lc(k) && !groupedKeys.has(lc(k)) && norm(row[k]))
        .filter(k => lc(k) !== "timestamp" && lc(k) !== "horodatage")
        .map(k => {
          const v = norm(row[k]);
          const parts = splitMulti(v);
          if(parts.length > 1){
            const pills = parts.map(x => `<span class="pill">${escapeHtml(x)}</span>`).join(" ");
            return `<span class="badge bg-light text-dark badge-kv"><span class="key">${escapeHtml(k)}:</span> ${pills}</span>`;
          }
          if(isLikelyUrl(v)){
            return `<span class="badge bg-light text-dark badge-kv"><span class="key">${escapeHtml(k)}:</span> <a href="${escapeUrl(v)}" target="_blank" rel="noopener">${escapeHtml(v)}</a></span>`;
          }
          return `<span class="badge bg-light text-dark badge-kv"><span class="key">${escapeHtml(k)}:</span> ${escapeHtml(v)}</span>`;
        });

      // 4) HTML carte
      return `
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title mb-1">${escapeHtml(title)}</h5>
            ${summary ? `<p class="card-text">${escapeHtml(summary)}</p>` : ``}
            ${sections.join("")}
            ${misc.length ? `<div class="mt-2">${misc.join(" ")}</div>` : ``}
          </div>
        </div>
      `;
    }

    function render(){
      const grid = d3.select("#grid");
      grid.html("");

      if(!FILTERED.length){
        d3.select("#count").text("Aucun résultat.");
        return;
      }

      d3.select("#count").text(`${FILTERED.length} projet(s)`);

      grid.selectAll(".col")
        .data(FILTERED)
        .enter()
        .append("div")
        .attr("class","col")
        .html(d => buildCard(d));
    }

    function isLikelyUrl(s){
      return /^https?:\/\/|^www\./i.test(s);
    }

    function escapeHtml(s){
      return s
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function escapeUrl(s){
      try { return new URL(s).toString(); }
      catch { return s; }
    }

    function searchFilter(q, key){
      const qlc = lc(q);
      return RAW.filter(row => {
        // Filtre par colonne spécifique si choisi
        if(key){
          const val = row[key] ?? "";
          return lc(val).includes(qlc);
        }
        // Sinon, recherche plein texte sur toutes les colonnes
        return Object.values(row).some(v => lc(v).includes(qlc));
      });
    }

    function populateKeySelect(){
      const sel = document.getElementById("keySelect");
      sel.innerHTML = `<option value="">— Filtrer par colonne —</option>`;
      ALL_KEYS.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        sel.appendChild(opt);
      });
    }

    // === 4) INIT ===
    document.getElementById("downloadCsv").href = CSV_URL;

    d3.csv(CSV_URL).then(rows => {
      RAW = rows.map(r => {
        // Trim de toutes les valeurs
        const o = {};
        Object.keys(r).forEach(k => { o[k.trim()] = (r[k] ?? "").toString().trim(); });
        return o;
      });

      // Collecte des clés (colonnes)
      const keySet = new Set();
      RAW.forEach(r => Object.keys(r).forEach(k => keySet.add(k)));
      ALL_KEYS = Array.from(keySet);

      populateKeySelect();

      FILTERED = RAW.slice();
      render();
    }).catch(err => {
      console.error(err);
      d3.select("#count").text("Erreur de chargement du CSV. Vérifie que la feuille est bien publiée en CSV.");
    });

    // === 5) ÉCOUTEURS ===
    const qInput = document.getElementById("q");
    const keySel = document.getElementById("keySelect");

    function applyFilters(){
      const q = qInput.value || "";
      const key = keySel.value || "";
      FILTERED = searchFilter(q, key);
      render();
    }

    qInput.addEventListener("input", applyFilters);
    keySel.addEventListener("change", applyFilters);
  })();
  </script>
</body>
</html>
